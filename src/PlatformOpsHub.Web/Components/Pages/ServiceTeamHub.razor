@page "/service"
@using MediatR
@using Microsoft.EntityFrameworkCore
@using PlatformOpsHub.Infrastructure.Data
@inject ApplicationDbContext Context

<FluentTypography Typo="Typography.H2">Service Team Hub</FluentTypography>
<FluentTypography Typo="Typography.Body">Nightly regression tracking, environment health, and release reviews.</FluentTypography>

<FluentGrid Style="margin-top: 20px;" Spacing="3">
    <!-- Regression Trend -->
    <FluentGridItem xs="12" md="8">
        <FluentCard>
            <FluentTypography Typo="Typography.H4">Nightly Regression Trend</FluentTypography>
            <div style="height: 200px; display: flex; align-items: flex-end; gap: 5px; padding: 10px;">
                @foreach (var run in recentRuns)
                {
                    var height = (run.Passed * 100 / run.Total);
                    <div title="Date: @run.RunAt.ToShortDateString(), Pass: @run.Passed/@run.Total" 
                         style="flex: 1; height: @height%; background-color: @(height > 90 ? "#28a745" : "#ffc107"); cursor: pointer;">
                    </div>
                }
            </div>
            <FluentTypography Typo="Typography.Caption">Last 14 Days Pass Rate Trend</FluentTypography>
        </FluentCard>
    </FluentGridItem>

    <!-- Health Stats -->
    <FluentGridItem xs="12" md="4">
        <FluentCard>
            <FluentStack Orientation="Orientation.Vertical">
                <FluentTypography Typo="Typography.H4">Environment Health</FluentTypography>
                <FluentStack Orientation="Orientation.Horizontal">
                    <FluentIcon Value="@(new Icons.Filled.Size20.CheckmarkCircle())" Color="Color.Success" />
                    <FluentTypography Typo="Typography.Body">Production: <b>Stable</b></FluentTypography>
                </FluentStack>
                <FluentStack Orientation="Orientation.Horizontal">
                    <FluentIcon Value="@(new Icons.Filled.Size20.CheckmarkCircle())" Color="Color.Success" />
                    <FluentTypography Typo="Typography.Body">Staging: <b>Healthy</b></FluentTypography>
                </FluentStack>
                <FluentStack Orientation="Orientation.Horizontal">
                    <FluentIcon Value="@(new Icons.Filled.Size20.Warning())" Color="Color.Warning" />
                    <FluentTypography Typo="Typography.Body">Dev: <b>High Load</b></FluentTypography>
                </FluentStack>
            </FluentStack>
        </FluentCard>
    </FluentGridItem>

    <!-- Upcoming Deployments -->
    <FluentGridItem xs="12">
        <FluentCard>
            <FluentTypography Typo="Typography.H4">Upcoming Deployments</FluentTypography>
            <FluentDataGrid Items="@upcomingDeployments">
                <PropertyColumn Property="@(d => d.PlannedAt)" Title="Planned Date" Format="dd/MM/yyyy HH:mm" />
                <PropertyColumn Property="@(d => d.Env)" Title="Environment" />
                <PropertyColumn Property="@(d => d.ReleaseId)" Title="Release ID" />
                <TemplateColumn Title="Status">
                   <FluentBadge Appearance="Appearance.Neutral">Planned</FluentBadge>
                </TemplateColumn>
            </FluentDataGrid>
        </FluentCard>
    </FluentGridItem>
</FluentGrid>

@code {
    private List<PlatformOpsHub.Domain.Entities.RegressionRun> recentRuns = new();
    private IQueryable<PlatformOpsHub.Domain.Entities.Deployment>? upcomingDeployments;

    protected override async Task OnInitializedAsync()
    {
        recentRuns = await Context.RegressionRuns
            .OrderByDescending(r => r.RunAt)
            .Take(14)
            .Reverse()
            .ToListAsync();

        upcomingDeployments = Context.Deployments
            .Where(d => d.DeployedAt == null && d.PlannedAt >= DateTime.UtcNow)
            .OrderBy(d => d.PlannedAt)
            .AsQueryable();
    }
}
