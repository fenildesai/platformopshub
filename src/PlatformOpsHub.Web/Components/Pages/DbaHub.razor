@page "/dba"
@using MediatR
@using Microsoft.EntityFrameworkCore
@using PlatformOpsHub.Infrastructure.Data
@inject ApplicationDbContext Context

<FluentTypography Typo="Typography.H2">DBA Team Hub</FluentTypography>
<FluentTypography Typo="Typography.Body">Database maintenance, health tracking, and optimization tasks.</FluentTypography>

<FluentGrid Style="margin-top: 20px;" Spacing="3">
    <!-- Active Maintenance -->
    <FluentGridItem xs="12" md="8">
        <FluentCard>
            <FluentTypography Typo="Typography.H4">Upcoming Maintenance</FluentTypography>
            <FluentDataGrid Items="@upcomingMaintenance">
                <PropertyColumn Property="@(m => m.Instance)" Title="Instance" />
                <PropertyColumn Property="@(m => m.Database)" Title="Database" />
                <PropertyColumn Property="@(m => m.TaskType)" Title="Task" />
                <PropertyColumn Property="@(m => m.PlannedAt)" Title="Planned" Format="dd/MM/yyyy HH:mm" />
                <TemplateColumn Title="Env">
                    <FluentBadge Appearance="Appearance.Neutral">@context.Env</FluentBadge>
                </TemplateColumn>
            </FluentDataGrid>
        </FluentCard>
    </FluentGridItem>

    <!-- DB Stats -->
    <FluentGridItem xs="12" md="4">
        <FluentCard>
            <FluentStack Orientation="Orientation.Vertical">
                <FluentTypography Typo="Typography.H4">Instance Health</FluentTypography>
                <FluentStack Orientation="Orientation.Horizontal">
                    <div style="width: 12px; height: 12px; border-radius: 50%; background-color: green;"></div>
                    <FluentTypography Typo="Typography.Body">SQL-PROD-01 (UK South)</FluentTypography>
                </FluentStack>
                <FluentStack Orientation="Orientation.Horizontal">
                    <div style="width: 12px; height: 12px; border-radius: 50%; background-color: green;"></div>
                    <FluentTypography Typo="Typography.Body">SQL-STG-01 (UK West)</FluentTypography>
                </FluentStack>
                <FluentStack Orientation="Orientation.Horizontal">
                    <div style="width: 12px; height: 12px; border-radius: 50%; background-color: orange;"></div>
                    <FluentTypography Typo="Typography.Body">SQL-DEV-01 (UK South)</FluentTypography>
                </FluentStack>
            </FluentStack>
        </FluentCard>
    </FluentGridItem>

    <!-- Recent DBA Tasks -->
    <FluentGridItem xs="12">
        <FluentCard>
            <FluentTypography Typo="Typography.H4">Completed Enhancements</FluentTypography>
            <FluentDataGrid Items="@completedMaintenance" Pagination="@pagination">
                <PropertyColumn Property="@(m => m.CompletedAt)" Title="Completed" Format="dd/MM/yyyy" />
                <PropertyColumn Property="@(m => m.Instance)" Title="Instance" />
                <PropertyColumn Property="@(m => m.TaskType)" Title="Task" />
                <PropertyColumn Property="@(m => m.Impact)" Title="Impact" />
            </FluentDataGrid>
            <FluentPaginator State="@pagination" />
        </FluentCard>
    </FluentGridItem>
</FluentGrid>

@code {
    private IQueryable<PlatformOpsHub.Domain.Entities.DbaMaintenance>? upcomingMaintenance;
    private IQueryable<PlatformOpsHub.Domain.Entities.DbaMaintenance>? completedMaintenance;
    private PaginationState pagination = new PaginationState { ItemsPerPage = 5 };

    protected override void OnInitialized()
    {
        upcomingMaintenance = Context.DbaMaintenances
            .Where(m => m.CompletedAt == null)
            .OrderBy(m => m.PlannedAt)
            .AsQueryable();

        completedMaintenance = Context.DbaMaintenances
            .Where(m => m.CompletedAt != null)
            .OrderByDescending(m => m.CompletedAt)
            .AsQueryable();
    }
}
