@page "/learning"
@using Microsoft.EntityFrameworkCore
@using PlatformOpsHub.Infrastructure.Data
@inject ApplicationDbContext Context

<FluentTypography Typo="Typography.H2">Learning & Growth</FluentTypography>
<FluentTypography Typo="Typography.Body">Expand your skills in cloud, devops, and artificial intelligence.</FluentTypography>

<FluentGrid Style="margin-top: 20px;" Spacing="3">
    <!-- Learning Paths -->
    <FluentGridItem xs="12" md="8">
        <FluentTypography Typo="Typography.H4">Current Modules</FluentTypography>
        <FluentStack Orientation="Orientation.Vertical" Spacing="4" Style="margin-top: 10px;">
            @foreach (var content in modules)
            {
                <FluentCard Appearance="Appearance.Filled" Style="width: 100%;">
                    <FluentStack Orientation="Orientation.Horizontal" VerticalAlignment="VerticalAlignment.Center">
                        <FluentIcon Value="@GetIcon(content.Category)" Color="Color.Accent" />
                        <FluentStack Orientation="Orientation.Vertical" Style="flex: 1;">
                            <FluentTypography Typo="Typography.H6">@content.Title</FluentTypography>
                            <FluentTypography Typo="Typography.Caption">Category: @content.Category</FluentTypography>
                        </FluentStack>
                        <FluentButton Appearance="Appearance.Accent" Href="@($"/learning/view/{content.Id}")">Start Reading</FluentButton>
                        <FluentButton Appearance="Appearance.Lightweight" Href="@($"/learning/quiz/{content.Category}")">Take Quiz</FluentButton>
                    </FluentStack>
                </FluentCard>
            }
        </FluentStack>
    </FluentGridItem>

    <!-- Leaderboard -->
    <FluentGridItem xs="12" md="4">
        <FluentCard>
            <FluentTypography Typo="Typography.H4">Leaderboard</FluentTypography>
            <FluentStack Orientation="Orientation.Vertical" Style="margin-top: 10px;">
                @foreach (var user in leaderboard)
                {
                    <FluentStack Orientation="Orientation.Horizontal" VerticalAlignment="VerticalAlignment.Center">
                        <FluentBadge Appearance="Appearance.Neutral">#@leaderboard.IndexOf(user) + 1</FluentBadge>
                        <FluentTypography Typo="Typography.Body">@user.DisplayName</FluentTypography>
                        <FluentSpacer />
                        <FluentBadge Appearance="Appearance.Accent">@user.TotalPoints pts</FluentBadge>
                    </FluentStack>
                    <FluentDivider Style="width: 100%;" />
                }
            </FluentStack>
            <FluentButton Style="margin-top: 15px; width: 100%;" Appearance="Appearance.Lightweight">View All</FluentButton>
        </FluentCard>
    </FluentGridItem>
</FluentGrid>

@code {
    private List<PlatformOpsHub.Domain.Entities.LearningContent> modules = new();
    private List<PlatformOpsHub.Domain.Entities.User> leaderboard = new();

    protected override async Task OnInitializedAsync()
    {
        modules = await Context.LearningContents
            .Where(c => c.IsPublished)
            .OrderBy(c => c.Category)
            .ToListAsync();

        leaderboard = await Context.Users
            .OrderByDescending(u => u.TotalPoints)
            .Take(10)
            .ToListAsync();
    }

    private Icon GetIcon(string category) => category switch
    {
        "Azure" => new Icons.Regular.Size24.Cloud(),
        "ADO" => new Icons.Regular.Size24.Stream(),
        "GenAI" => new Icons.Regular.Size24.Sparkle(),
        _ => new Icons.Regular.Size24.Book()
    };
}
