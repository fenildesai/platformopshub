@page "/team"
@using Microsoft.EntityFrameworkCore
@using PlatformOpsHub.Infrastructure.Data
@using Microsoft.FluentUI.AspNetCore.Components
@inject ApplicationDbContext Context

<FluentTypography Typo="Typography.H2">Who We Are</FluentTypography>
<FluentTypography Typo="Typography.Body">Meet the PlatformOps family.</FluentTypography>

<FluentGrid Style="margin-top: 20px;" Spacing="3">
    <!-- Filters -->
    <FluentGridItem xs="12">
        <FluentStack Orientation="Orientation.Horizontal">
            <FluentSelect TOption="string" Label="Team" Items="@teamNames" @bind-Value="selectedTeam" />
            <FluentSearch Placeholder="Search member..." />
        </FluentStack>
    </FluentGridItem>

    <!-- User Cards -->
    @foreach (var user in FilteredUsers)
    {
        <FluentGridItem xs="12" sm="6" md="4" lg="3">
            <FluentCard Style="text-align: center; height: 100%;">
                <FluentPersona Name="@user.DisplayName" 
                               Image="@user.PhotoUrl" 
                               ImageSize="72px" 
                               Style="margin: 0 auto;" />
                
                <FluentTypography Typo="Typography.H6" Style="margin-top: 10px;">@user.DisplayName</FluentTypography>
                <FluentTypography Typo="Typography.Caption" Style="color: gray;">@user.Role</FluentTypography>
                <div style="margin-top: 5px;">
                    <FluentBadge Appearance="Appearance.Neutral">@user.Team?.Name</FluentBadge>
                </div>
                
                @if (user.Birthday?.Month == DateTime.UtcNow.Month && user.Birthday?.Day == DateTime.UtcNow.Day)
                {
                    <div style="margin-top: 10px;">
                        <FluentBadge Appearance="Appearance.Accent">ðŸŽ‚ Birthday Today!</FluentBadge>
                    </div>
                }

                @if (user.JoinDate?.Month == DateTime.UtcNow.Month && user.JoinDate?.Day == DateTime.UtcNow.Day)
                {
                    <div style="margin-top: 5px;">
                        <FluentBadge Appearance="Appearance.Accent">ðŸŽ‰ Anniversary!</FluentBadge>
                    </div>
                }

                <div style="margin-top: 15px;">
                    <FluentButton Appearance="Appearance.Lightweight" IconStart="@(new Icons.Regular.Size16.Chat())">Say Hi</FluentButton>
                </div>
            </FluentCard>
        </FluentGridItem>
    }
</FluentGrid>

@code {
    private List<PlatformOpsHub.Domain.Entities.User> users = new();
    private List<string> teamNames = new() { "All" };
    private string selectedTeam = "All";

    protected override async Task OnInitializedAsync()
    {
        users = await Context.Users
            .Include(u => u.Team)
            .OrderBy(u => u.DisplayName)
            .ToListAsync();

        var teams = users.Select(u => u.Team?.Name).Where(n => n != null).Distinct().ToList();
        teamNames.AddRange(teams!);
    }

    private IEnumerable<PlatformOpsHub.Domain.Entities.User> FilteredUsers => 
        selectedTeam == "All" 
            ? users 
            : users.Where(u => u.Team?.Name == selectedTeam);
}
