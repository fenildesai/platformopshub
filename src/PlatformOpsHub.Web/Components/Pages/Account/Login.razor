@page "/Account/Login"
@layout Layout.LoginLayout
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Identity
@inject SignInManager<IdentityUser> SignInManager
@inject UserManager<IdentityUser> UserManager
@inject NavigationManager NavigationManager

<PageTitle>Login - PlatformOps Hub</PageTitle>

<FluentCard Style="width: 400px; padding: 30px;">
    <FluentStack Orientation="Orientation.Vertical" VerticalAlignment="VerticalAlignment.Center" Spacing="4">
        <FluentIcon Value="@(new Icons.Filled.Size32.LockClosed())" Color="Color.Accent" />
        <FluentTypography Typo="Typography.H3">Login</FluentTypography>
        <FluentTypography Typo="Typography.Body">Enter your credentials to access the hub.</FluentTypography>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <FluentMessageBar Title="Error" Intent="MessageIntent.Error">
                @errorMessage
            </FluentMessageBar>
        }

        <FluentTextField @bind-Value="Input.Email" Label="Email" Required="true" Style="width: 100%;" />
        <FluentTextField @bind-Value="Input.Password" Label="Password" Required="true" TextFieldType="TextFieldType.Password" Style="width: 100%;" />

        <FluentCheckbox @bind-Value="Input.RememberMe" Label="Remember me" />

        <FluentButton Type="ButtonType.Submit" Appearance="Appearance.Accent" Style="width: 100%;" OnClick="OnLogin">Log in</FluentButton>
    </FluentStack>
</FluentCard>

@code {
    private string? errorMessage;

    [SupplyParameterFromForm]
    private InputModel Input { get; set; } = new();

    private async Task OnLogin()
    {
        errorMessage = null;

        var result = await SignInManager.PasswordSignInAsync(Input.Email, Input.Password, Input.RememberMe, lockoutOnFailure: false);
        if (result.Succeeded)
        {
            NavigationManager.NavigateTo("/");
        }
        else
        {
            errorMessage = "Invalid login attempt.";
        }
    }

    private sealed class InputModel
    {
        [Required]
        [EmailAddress]
        public string Email { get; set; } = "";

        [Required]
        [DataType(DataType.Password)]
        public string Password { get; set; } = "";

        public bool RememberMe { get; set; }
    }
}
